<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]>      <html class="no-js"> <!--<![endif]-->
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Ecomm MVP Sandbox</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>

    <!-- Header -->
    <header class="header">
        <img src="images/placeholder-header.png" alt="Header Image">
    </header>

    <!-- Start Multi-Step Form -->
    <section class="stepsContainer">
        <div id="multiStepForm">

            <!-- Step 1 -->
            <div class="step active">
                <h1>Breathe easy with whole home air purification.</h1>
                <h2>Start your FREE air analysis today!</h2>
                <input type="text" id="address" name="address" placeholder="Enter your home address">
                <button class="btn-primary" onclick="moveToStep(2)">Start Air Analysis</button>
            </div>

            <!-- Loading Page -->
            <div class="step">
                <h1>Breathe easy with whole home air purification.</h1>
                <img class="spinning" src="images/hourglass.png" alt="Loading" width="100px">
            </div>

            <!-- Step 2 -->
            <div class="step parentContainer">
                <div class="leftContainer">
                    <h1>Air quality assessment near <span id="location"></span></h1>
                    <table class="airQualityMarkers">
                        <tr>
                            <td class="iconStats">
                                <img src="https://dev-aerovita.pantheonsite.io/wp-content/uploads/2023/08/icon-water-waves.png"
                                    alt="Air Waves" width="20px">
                                <br>
                                <span id="aqi"></span>
                            </td>
                            <td>
                                <strong>AQI (Local Air Quality Index)</strong><br>
                                <span id="actionDay"></span>
                            </td>
                        </tr>
                        <tr></tr>
                        <tr>
                            <td class="iconStats">
                                <img src="https://dev-aerovita.pantheonsite.io/wp-content/uploads/2023/08/icon-drop.png"
                                    alt="Humidity" width="20px">
                                <br>
                                <span id="humidity">78%</span>
                            </td>
                            <td>
                                <strong>Humidity Level</strong><br>
                                <span id="humidity">78% - High</span>
                            </td>
                        </tr>
                    </table>
                    <br>
                    <button class="btn-large" onclick="moveToStep(4)">Continue</button>
                </div>
                <div class="rightContainer">
                    <div id="map" class="mapContainer"></div>
                </div>
            </div>

            <!-- Email Modal -->
            <div id="emailModal" class="modal">
                <div class="modal-content">
                    <span class="close-btn">&times;</span>
                    <h1>Save your progress</h1>
                    <p>Enter your email address to continue.</p>
                        <!-- Start: Customer Data Collection -->
                        <form id="customerForm">
                            <input type="hidden" name="first_name" value="Mike">
                            <input type="hidden" name="last_name" value="Test">
                            <input type="email" name="email" placeholder="Email Address">
                            <input type="submit" class="btn-large" onclick="closeModal()" value="Continue">
                        </form>
                        <!-- End: Customer Data Collection -->
                    <span style="font-size: 8px; color: #999; margin-top: 10px; display: block;">
                    By entering your email address, you agree to our Terms of Service and Privacy Policy.
                    </span>
                </div>
            </div>

            <!-- Step 3 -->
            <div class="step choices">
                <p class="muted">1 of 7</p>
                <h1>What is important to you?</h1>
                <input type="radio" id="allergies" name="importance" value="allergies"> <label for="allergies">Reduce
                    Allergies or Sneezing</label><br>
                <input type="radio" id="environment" name="importance" value="environment"> <label
                    for="environment">Better Environments for Kids or Pets</label><br>
                <input type="radio" id="energy" name="importance" value="energy"> <label for="energy">Energy Savings and
                    Maintenance</label><br>
                <input type="radio" id="all" name="importance" value="all"> <label for="all">All of the
                    Above</label><br>
                <button class="btn-large" onclick="moveToStep(5)">Continue</button>
            </div>

            <!-- Step 4 -->
            <div class="step choices">
                <p class="muted">2 of 7</p>
                <h1>How would you rate you home's air?</h1>
                <input type="radio" id="allergies" name="importance" value="allergies"> <label for="allergies">There's
                    dust and dander</label><br>
                <input type="radio" id="environment" name="importance" value="environment"> <label for="environment">It
                    has a strong odor</label><br>
                <input type="radio" id="energy" name="importance" value="energy"> <label for="energy">It's
                    fine</label><br>
                <input type="radio" id="all" name="importance" value="all"> <label for="all">I'm not sure</label><br>
                <button class="btn-large" onclick="moveToStep(6)">Continue</button>
                <br>
                <button class="btn-large-white" onclick="moveToStep(4)">Back</button>
            </div>

            <!-- Step 5 -->
            <div class="step choices">
                <p class="muted">3 of 7</p>
                <h1>Who lives in your home?</h1>
                <input type="radio" id="allergies" name="importance" value="allergies"> <label
                    for="allergies">Adults</label><br>
                <input type="radio" id="environment" name="importance" value="environment"> <label
                    for="environment">Adults + Kids</label><br>
                <input type="radio" id="energy" name="importance" value="energy"> <label for="energy">Adults +
                    Pets</label><br>
                <input type="radio" id="all" name="importance" value="all"> <label for="all">Adults + Kids +
                    Pets</label><br>
                <button class="btn-large" onclick="moveToStep(7)">Continue</button>
                <br>
                <button class="btn-large-white" onclick="moveToStep(5)">Back</button>
            </div>

            <!-- Step 6 -->
            <div class="step choices">
                <p class="muted">4 of 7</p>
                <h1>How old is your furnace?</h1>
                <input type="radio" id="allergies" name="importance" value="allergies"> <label for="allergies">Brand
                    new</label><br>
                <input type="radio" id="environment" name="importance" value="environment"> <label
                    for="environment">Less than 10 years old</label><br>
                <input type="radio" id="energy" name="importance" value="energy"> <label for="energy">10-15 years
                    old</label><br>
                <input type="radio" id="all" name="importance" value="all"> <label for="all">Over 20 years
                    old</label><br>
                <button class="btn-large" onclick="moveToStep(8)">Continue</button>
                <br>
                <button class="btn-large-white" onclick="moveToStep(6)">Back</button>
            </div>

            <!-- Step 7 -->
            <div class="step choices">
                <p class="muted">5 of 7</p>
                <h1>How often do you change filters?</h1>
                <input type="radio" id="allergies" name="importance" value="allergies"> <label for="allergies">Once per
                    month</label><br>
                <input type="radio" id="environment" name="importance" value="environment"> <label
                    for="environment">Every 3 months or so</label><br>
                <input type="radio" id="energy" name="importance" value="energy"> <label for="energy">It's been
                    awhile...</label><br>
                <input type="radio" id="all" name="importance" value="all"> <label for="all">My furnace doesn't have a
                    filter</label><br>
                <button class="btn-large" onclick="moveToStep(9)">Continue</button>
                <br>
                <button class="btn-large-white" onclick="moveToStep(7)">Back</button>
            </div>

            <!-- Step 8 -->
            <div class="step choices">
                <p class="muted">6 of 7</p>
                <h1>Do you use an air purifier or humidifier?</h1>
                <input type="radio" id="allergies" name="importance" value="allergies"> <label for="allergies">Air
                    purifier</label><br>
                <input type="radio" id="environment" name="importance" value="environment"> <label
                    for="environment">Humidifier</label><br>
                <input type="radio" id="energy" name="importance" value="energy"> <label for="energy">Air purifier +
                    humidifier</label><br>
                <input type="radio" id="all" name="importance" value="all"> <label for="all">None of the
                    above</label><br>
                <button class="btn-large" onclick="moveToStep(10)">Continue</button>
                <br>
                <button class="btn-large-white" onclick="moveToStep(8)">Back</button>
            </div>

            <!-- Step 9 -->
            <div class="step choices">
                <p class="muted">7 of 7</p>
                <h1>Have you ever cleaned your air ducts?</h1>
                <input type="radio" id="never" name="importance" value="never"> <label for="never">Never</label><br>
                <input type="radio" id="environment" name="importance" value="environment"> <label
                    for="environment">It's been awhile</label><br>
                <input type="radio" id="energy" name="importance" value="energy"> <label for="energy">Within the last year</label><br>
                <input type="radio" id="all" name="importance" value="all"> <label for="all">What's an air duct?</label><br>
                <button class="btn-large" onclick="window.location.href = 'shop.html'">Continue</button>
                <br>
                <button class="btn-large-white" onclick="moveToStep(9)">Back</button>
            </div>

        </div>
    </section>


    <!-- Main JS -->
    <!-- Include jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>

        //Multi Step Form functions
        function moveToStep(step) {
            if (step === 2) {
                var zipCode = document.getElementById('address').value;

                // Geocoding request to get latitude and longitude
                var geocoder = new google.maps.Geocoder();
                geocoder.geocode({ 'address': zipCode }, function (results, status) {
                    if (status === 'OK') {
                        map.setCenter(results[0].geometry.location);
                        map.setZoom(12);
                    } else {
                        alert('Geocode was not successful for the following reason: ' + status);
                    }
                });

                // AirNow Air quality API request
                var apiUrl = 'https://www.airnowapi.org/aq/forecast/zipCode/?format=text/csv&zipCode=' + zipCode + '&date=2023-08-10&distance=25&API_KEY=8B46027D-335B-45ED-B67B-22A5B1B8DF6A';

                // Fetch data from API
                fetch(apiUrl)
                    .then(response => response.text())
                    .then(data => {
                        var lines = data.split('\n');
                        var values = lines[1].split(',');
                        var location = values[2].replace(/"/g, ''); 
                        var aqi = values[7].replace(/"/g, ''); 
                        var actionDay = values[9].replace(/"/g, ''); 

                        document.getElementById('location').innerText = "" + location;
                        document.getElementById('aqi').innerText = "" + aqi;
                        document.getElementById('actionDay').innerText = "" + actionDay; 
                    })
                    .catch(error => {
                        console.error('There was an error fetching the air quality data:', error);
                    });

                // Show the loading page
                var steps = document.querySelectorAll('.step');
                for (var i = 0; i < steps.length; i++) {
                    steps[i].classList.remove('active');
                }
                steps[step - 1].classList.add('active');

                // Wait for 3 seconds before moving to the next step
                setTimeout(function () {
                    moveToStep(3);
                }, 3000);
                return; 
            }

            if(step === 4) { // Display modal after Step 3
                showModal();
            }

            var steps = document.querySelectorAll('.step');
            for (var i = 0; i < steps.length; i++) {
                steps[i].classList.remove('active');
            }
            steps[step - 1].classList.add('active');
        }


        function submitForm() {
            alert('From here we continue to the final questions and begin Shopify integration steps.');
        }

        moveToStep(1); // Start at step 1

        //Modal functions
        function showModal() {
            document.getElementById('emailModal').style.display = "block";
        }

        function closeModal() {
            document.getElementById('emailModal').style.display = "none";
        }

        document.querySelector(".close-btn").addEventListener("click", closeModal);
    </script>

    <!-- Initialize Google Map -->
    <script async src="https://maps.googleapis.com/maps/api/js?key=<%= GOOGLE_API_KEY %>&callback=initMap&libraries=places"></script>
    <script>
        var map;
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 37.0902, lng: -95.7129 },
                zoom: 4,
                mapTypeControl: false,
                streetViewControl: false,
                zoomControl: false,
                fullscreenControl: false,
                rotateControl: false,
                scaleControl: false
            });

            // Initialize autocomplete on the address input field
            var addressInput = document.getElementById('address');
            var autocomplete = new google.maps.places.Autocomplete(addressInput);
            autocomplete.setFields(['address_components', 'geometry']);

            // Event listener to capture the selected place
            autocomplete.addListener('place_changed', function () {
                var place = autocomplete.getPlace();
                if (place.geometry) {
                    // Extract the postal code (zip code) from the address components
                    var zipCode = null;
                    for (var i = 0; i < place.address_components.length; i++) {
                        var component = place.address_components[i];
                        if (component.types.indexOf('postal_code') !== -1) {
                            zipCode = component.long_name;
                            break;
                        }
                    }
                    if (zipCode) {
                        document.getElementById('address').value = zipCode; // Update the address input field with the zip code
                    }
                }
            });
        }
    </script>

    <!-- Shopify API on from submit -->
    <script>
    document.getElementById('customerForm').addEventListener('submit', async function(event) {
        event.preventDefault();

        const formData = new FormData(event.target);
        const data = {
            first_name: $('[name=first_name]').val(),
            last_name: $('[name=last_name]').val(),
            email: $('[name=email]').val()
        };

        try {
            let response = await fetch('/submitForm', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            if(response.ok) {
                alert('Customer added successfully!');
            } else {
                alert('Error adding customer!');
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    });
    </script>

</body>
</html>